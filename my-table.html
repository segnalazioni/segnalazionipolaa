<link rel="impport" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/google-map/google-map.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/device-icons.html">
<link rel="import" href="bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="bower_components/paper-datatable/paper-datatable.html">
<link rel="import" href="bower_components/paper-datatable/paper-datatable-styles.html">
<link rel="import" href="bower_components/paper-datatable/paper-datatable-edit-dialog.html">
<link rel="import" href="bower_components/paper-datatable/my-datatable-card.html">
<link rel="import" href="bower_components/paper-datatable/paper-datatable-card.html">
<link rel="import" href="bower_components/paper-datatable/paper-datatable-column.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/iron-list/iron-list.html">

<dom-module id="my-table">
<style>

</style>
<template>
    <my-datatable-card page-size="2" data-source="{{data}}" id-property="id" header="{{mHeader}}">
        <paper-datatable resize-behavior="dynamic-columns">
            <paper-datatable-column header="ID" property="id" sortable>
            </paper-datatable-column>
            <paper-datatable-column header="Data" property="data" sortable>
            </paper-datatable-column>
            <paper-datatable-column header="Commento" property="commento" sortable>
            </paper-datatable-column>
        </paper-datatable>
    </my-datatable-card>
</template>

</dom-module>
<script>
	Polymer({
		is: 'my-table',

		properties:{
			data: Object,
            mHeader: String
		},

		ready: function() {
            this.mHeader = "test header";

            var myData = [];
            for (var i=0; i<142; i++) {
                var id = Math.round(Math.random() * 24);
                var rating = Math.round(Math.random() * 2000)+1000;
                myData.push({
                    id: i,
                    data: "20-08-2016 "+id+":00",
                    commento: "Segnalazione confermata "+ i
                });
            }
            window.myData = myData;

            this.data = {
                get: function(sort, page, pageSize){
                    console.log('just once? :/');
                    return new Promise(function(resolve, reject){
                        myData.sort(function(a,b){
                            if(sort.direction == "desc"){
                                var c = a;
                                a = b;
                                b = c;
                            }
                            if(a[sort.property] > b[sort.property]) return 1;
                            if(a[sort.property] < b[sort.property]) return -1;
                            return 0;
                        });
                        resolve(myData.slice((page-1)*pageSize, page*pageSize));
                    });
                },
                set: function(item, property, value){
                    return new Promise(function(resolve, reject){
                        console.info("a save was triggered", [item, property, value]);
                        if(item.id === '__new__'){
                            //validate item, if invalid (and thus not savable yet) reject, otherwise return it's new id
                            console.warn('this is for the time being deprecated');
                            /*
                             if(item.author.first.length > 0 && item.author.last.length > 0){
                             console.log('trigger save');
                             var id = Math.round(Math.random() * 10000);

                             item.id = id;
                             myData.push(item);
                             app.set('data.length', myData.length);
                             resolve(id);
                             }else{
                             console.log('no luck yet');
                             reject();
                             }*/
                        }else{
                            var myItem = myData.find(function(thisItem){
                                return thisItem.id == item.id;
                            });
                            myItem[property] = value;
                            resolve(true);
                        }
                    });

                },
                length:myData.length
            };
      	}
	});
</script>
